---
title: "p8105_hw5_sp4170"
author: "Shihui Peng"
date: "2023-11-15"
output: github_document
---
load package and set seed for reproducibility
```{r, echo=FALSE, message=FALSE}
library(tidyverse)
set.seed(1)
```


# problem 2

## data import

```{r}
file_import_df = 
  tibble(
    file_name = list.files(path = 'data/'),
    path = str_c('data/', file_name)
  ) |> 
  mutate(
    data = map(path, read_csv)
  ) |> 
  unnest(data)
```
* i create a df named 'file_import_df', make a tibble consisted of every file's name and their relative path. i use `mutate()` to create a new variable 'data', which contain every csv file i imported using `map()` function. I use `unnest()` to unnest contents of each cell of variable data.

## data tidy

```{r}
file_tidy_df = 
  file_import_df |> 
  janitor::clean_names() |> 
  separate(file_name, c('arm', 'subject_id'), sep = '\\_') |> 
  select(-path) |> 
  mutate(
    subject_id = str_remove(subject_id, '\\.csv'),
    arm = ifelse(arm == 'con', 'control', 'experiment')
  ) |> 
  pivot_longer(
    week_1 : week_8,
    names_to = 'observation_time',
    values_to = 'value',
    names_prefix = 'week_'
  ) |> 
  mutate(
    observation_time = as.numeric(observation_time)
  )
```
* i tidy the result:
  * i use `separate()` to create variable 'arm' and 'subject_id'. i remove column 'path' as it is not needed. i mutate variable subject_id by deleting the suffix and variable arm by renaming 'con' as 'control' and 'exp' as 'experience'. I tidy cols week_1 to week_8 and create col 'observation_time' indicating weeks for each observation time point and col 'value' for each value. i change the data type of variable observation_time from character type to numeric type.

## make a plot

```{r}
file_tidy_df |> 
  ggplot(aes(x = observation_time, y = value, color = subject_id, alpha = 0.5)) +
  geom_line() +
  facet_grid(. ~ arm)
```

* i make a spaghetti plot
* comment
  * the values of subjects in experiment arm suppress the values of subjects in control arm in the last observation time. in the baseline (the first observation time), both arms had similar value, while the spread of baseline value in experiment arm was larger than the spread in the control arm
  * the values of subjects in control arm across observation time did not change appreciably. but the values of subjects in experiment arm across observation time had an increase trend in general.


# problem 3

```{r}
sim_ttest = function(n_obs = 30, mu, sigma = 5){
  result_df = tibble(
      x_vec = rnorm(n = n_obs, mean = mu, sd = sigma)
  )
  
  result_df |> 
    summarise(
      mu_hat = t.test(x_vec, conf.level = 0.95) |> 
        broom::tidy()|> 
        pull(estimate),
      p_value = t.test(x_vec, conf.level = 0.95) |> 
        broom::tidy()|> 
        pull(p.value)
    ) 
}
```

* i create a function:  
  * create a data frame of normally distributed data (set n=30 and sigma(sd)=5). 
  * save mu_hat and the p-value arising from a test of H:μ=0 using α=0.05 with this data frame.

```{r}
output = vector('list', length = 5000)

for (i in 1:5000){
  output[[i]] = sim_ttest(mu = 0)
}

bind_rows(output)

sim_result_df = 
  tibble(
    mu = c(1,2,3,4,5,6)
  ) |> 
  mutate(
    output_list_mu = map(mu, ~rerun(5000, sim_ttest(mu = .x))),
    estimate_pvalue_df = map(output_list_mu, bind_rows)
  ) |> 
  unnest(estimate_pvalue_df) |> 
  select(-output_list_mu)
```

* i generate 5000 datasets from the model. set mu = 0. and i bind the results of estimates and p-values of t-tests
* i repeat the above for μ={1,2,3,4,5,6}
  * i first create a df for mu values
  * i create a list containing ttest results (mu_hat and p-values) for each mu value which reran by 5000 times, then i bind these results for each mu
  * i unnest the mu_hat and p-value dataframe and remove unnecessary cols


Make a plot showing the proportion of times the null was rejected (the power of the test) on the y axis and the true value of μ
 on the x axis. Describe the association between effect size and power.
```{r}

```
 
